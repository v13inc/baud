<!doctype html>
<html>
  <head>
    <title>baud</title>
    <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="banners.js"></script>
    <style>
      #container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateX(-50%) translateY(-50%);
        text-align: center;
      }
      #name { width: 100px; }
      #message { width: 200px; }
    </style>
  </head>
  <body>
    <div id="container">
      <pre id="text"></pre>
      <form id="message-form">
        <input type="text" name="message" id="message">
        <input type="text" name="name" id="name" value="Anon">
        <input type="submit" hidden>
      </form>
      <pre id="messages"></pre>
    </div>
    <script>
      function messagesEl() {
        return document.getElementById('messages');
      }

      function messageEl() {
        return document.getElementById('message');
      }

      function nameEl() {
        return document.getElementById('name');
      }

      function messageTemplate(m) {
        return m.message + '\n' + '  -' + m.name + '@' + m.date;
      }

      function showMessages(messages) {
        messagesEl().innerHTML = messages.map(messageTemplate).join('\n\n');
      }

      function getMessages() {
        $.get('/api', showMessages);
      }

      function submitMessage(e) {
        e.preventDefault();
        var data = {
          message: messageEl().value,
          name: nameEl().value
        };
        if(!data.message || !data.name) return;
        $.post('/api', data, showMessages); 
      }

      getMessages();
      $('#message-form').submit(submitMessage);




      function randomBanner() {
        var index = Math.floor(Math.random() * DATA.banners.length);
        return DATA.banners[index];
      }

      function showRandom() {
        showText(randomBanner());
      }

      function showText(text) {
        var el = document.getElementById('text');
        el.innerHTML = text;
      }

      function typeRandom() {
        var text = randomBanner();
        clear(function() {
            type(text);
        });
      }

      function clear(finished) {
        var el = document.getElementById('text');
        var text = el.innerHTML + '';
        var index = text.length - 1;
        var _clear = function() {
          if(index < 0) {
            clearInterval(interval);
            if(finished) finished();
          }
          console.log(index, text);
          el.innerHTML = text.substr(0, index--);
        }
        var interval = setInterval(_clear, 10);
      }

      function type(text, finished) {
        var el = document.getElementById('text');
        var index = 0;
        var _type = function() {
          if(index >= text.length) {
            clearInterval(interval);
            if(finished) finished();
          }
          el.innerHTML = text.substring(0, index++);
        }
        var interval = setInterval(_type, 10);
      }

      showRandom();
      setInterval(typeRandom, 10000);
    </script>
  </body>
</html>
